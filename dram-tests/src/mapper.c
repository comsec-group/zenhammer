#include "mapper.h"


size_t DRAM_MTX[FN_BITS] = {
0b000000000000000010000001000000,
0b000000000001000100000000000000,
0b000000000010001000000000000000,
0b000000000100010000000000000000,
0b000000001000100000000000000000,
0b000000000000000000000000000001,
0b000000000000000000000000000010,
0b000000000000000000000000000100,
0b000000000000000000000000001000,
0b000000000000000000000000010000,
0b000000000000000000000000100000,
0b000000000000000000000001000000,
0b000000000000000000000010000000,
0b000000000000000000000100000000,
0b000000000000000000001000000000,
0b000000000000000000010000000000,
0b000000000000000000100000000000,
0b000000000000000001000000000000,
0b000000000001000000000000000000,
0b000000000010000000000000000000,
0b000000000100000000000000000000,
0b000000001000000000000000000000,
0b000000010000000000000000000000,
0b000000100000000000000000000000,
0b000001000000000000000000000000,
0b000010000000000000000000000000,
0b000100000000000000000000000000,
0b001000000000000000000000000000,
0b010000000000000000000000000000,
0b100000000000000000000000000000
};

size_t PHYS_MTX[FN_BITS] = {
0b000000000000000000000000000001,
0b000000000000000000000000000010,
0b000000000000000000000000000100,
0b000000000000000000000000001000,
0b000000000000000000000000010000,
0b000000000000000000000000100000,
0b000000000000000000000001000000,
0b000000000000000000000010000000,
0b000000000000000000000100000000,
0b000000000000000000001000000000,
0b000000000000000000010000000000,
0b000000000000000000100000000000,
0b000010000000000000000100000000,
0b000100000000000000001000000000,
0b001000000000000000010000000000,
0b010000000000000000100000000000,
0b100000000001000000000000000000,
0b000000000000000001000000000000,
0b000000000000000010000000000000,
0b000000000000000100000000000000,
0b000000000000001000000000000000,
0b000000000000010000000000000000,
0b000000000000100000000000000000,
0b000000000001000000000000000000,
0b000000000010000000000000000000,
0b000000000100000000000000000000,
0b000000001000000000000000000000,
0b000000010000000000000000000000,
0b000000100000000000000000000000,
0b000001000000000000000000000000
};



DRAMAddr to_dram(physaddr_t p) {
	size_t res = 0;
	for (size_t i = 0; i < FN_BITS; i++) {
		res <<= 1ULL;
		res |=  (size_t) __builtin_parityl(p & DRAM_MTX[i]);
	}

	return (DRAMAddr) {(p & MSB_MASK), ((res & BK_MASK)>> BK_SHIFT),((res & ROW_MASK)>>ROW_SHIFT), ((res & COL_MASK)>>COL_SHIFT)};

}

static size_t linearize(DRAMAddr d) {
	return (d.bank << BK_SHIFT) | (d.row << ROW_SHIFT) | (d.col << COL_SHIFT);
}                                                                                 

physaddr_t to_phys(DRAMAddr d) {
	size_t res = 0;
	size_t l = linearize(d);
	for (size_t i = 0; i < FN_BITS; i++) {
		res <<= 1ULL;
		res |= (size_t) __builtin_parityl(l & PHYS_MTX[i]);
	}
	return (physaddr_t) d.msb | res;
}
